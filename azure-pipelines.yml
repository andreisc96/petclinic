# The below pipeline is designed to build the .jar for petclinic app and then deploy it from an Ansible control node
# https://aka.ms/yaml


trigger:
- main

pool:
  name: Default

stages:
  - stage: Lint
    displayName: 'Running linting tests on the repo'
    jobs:
#    - job: QodanaLint
#      steps:
#       - checkout: self

#       - script: |
#           mkdir -p $(System.DefaultWorkingDirectory)/qodana/results
#           rm -rf $(System.DefaultWorkingDirectory)/qodana/results/*
#         displayName: 'Create results path'

#       - script: |
#           set -e
#           docker run --rm -u $(id -u):$(id -g) \
#           -v $(System.DefaultWorkingDirectory):/data/project \
#           -v $(System.DefaultWorkingDirectory)/qodana/results:/data/results \
#           jetbrains/qodana-jvm-community:latest
#           --property project.open.type=Maven
#         displayName: 'Run linter'

#       - task: PublishBuildArtifacts@1
#         inputs:
#           PathtoPublish: '$(System.DefaultWorkingDirectory)/qodana/results'
#           ArtifactName: 'qodana-report'
#           publishLocation: 'Container'
    - job: MavenLint
      steps:
      - checkout: self
      - task: Maven@4
        inputs:
          mavenPomFile: 'pom.xml'
          goals: 'checkstyle:check'
          options: '-B -Dcheckstyle.failOnViolation=false'
          javaHomeOption: 'JDKVersion'
          mavenVersionOption: 'Default'
          mavenAuthenticateFeed: false
          effectivePomSkip: false
          sonarQubeRunAnalysis: false


  - stage: Test
    dependsOn: Lint
    displayName: 'Running unit tests'
    jobs:
      - job: RunUnitTests
        steps:
          - checkout: self
          - task: Maven@4
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-B -Dcheckstyle.failOnViolation=false'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              mavenVersionOption: 'Default'
              mavenAuthenticateFeed: false
              effectivePomSkip: false


  - stage: Build
    dependsOn: Test
    jobs:
    - job: BuildJob
      displayName: 'Build the .jar'
      steps:
      - task: Maven@4
        inputs:
          #azureSubscription: 'Azure subscription 1(0fa225b2-6ae6-47ee-931c-b34ef669c09c)'
          mavenPomFile: 'pom.xml'
          goals: 'package'
          options: '-B -Dcheckstyle.failOnViolation=false -DskipTests'
          javaHomeOption: 'JDKVersion'
          mavenVersionOption: 'Default'

      - publish: 'target/spring-petclinic-3.5.0-SNAPSHOT.jar'
        artifact: 'drop'

  - stage: Deploy
    dependsOn: Build 
    jobs:
    - job: DeployJob
      displayName: 'Deploy artifact on AS'
      steps:
       - download: current
         artifact: drop
       - script: ansible-playbook -i /home/osansible/ansibleconfig/inventories/inventory.ini /home/osansible/ansibleconfig/main_playbook.yml
         displayName: 'Deploying app with Ansible'    

